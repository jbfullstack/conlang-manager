// ============================================
// prisma/seed.ts - Script de seed mis √† jour
// ============================================

import { CATEGORY_KEYS } from '@/lib/categories';
import { PrismaClient } from '@prisma/client';
import bcrypt from 'bcryptjs';

const prisma = new PrismaClient();

async function main() {
  console.log('üå± Seed de la base de donn√©es...');

  // Nettoyer les donn√©es existantes (en d√©veloppement uniquement)
  if (process.env.NODE_ENV === 'development') {
    await prisma.conceptProperty.deleteMany();
    await prisma.combinationVote.deleteMany();
    await prisma.combination.deleteMany();
    await prisma.concept.deleteMany();
    await prisma.property.deleteMany();
    await prisma.user.deleteMany();
    console.log('üßπ Donn√©es existantes supprim√©es');
  }

  // Cr√©er des utilisateurs de test
  const hashedPassword = await bcrypt.hash('password123', 12);
  
  const users = await Promise.all([
    prisma.user.create({
      data: {
        username: 'admin',
        email: 'admin@conlang.local',
        passwordHash: hashedPassword,
        role: 'ADMIN',
      },
    }),
    prisma.user.create({
      data: {
        username: 'alice',
        email: 'alice@conlang.local', 
        passwordHash: hashedPassword,
        role: 'MEMBER',
      },
    }),
    prisma.user.create({
      data: {
        username: 'bob',
        email: 'bob@conlang.local',
        passwordHash: hashedPassword,
        role: 'MEMBER',
      },
    }),
    prisma.user.create({
      data: {
        username: 'charlie',
        email: 'charlie@conlang.local',
        passwordHash: hashedPassword,
        role: 'MODERATOR',
      },
    }),
  ]);

  console.log('üë• Utilisateurs cr√©√©s:', users.length);

  // Cr√©er les propri√©t√©s de base
  const properties = await Promise.all([
  // Propri√©t√©s physiques
  prisma.property.create({
    data: {
      name: 'liquide',
      description: '√âtat liquide de la mati√®re, qui coule facilement',
      category: CATEGORY_KEYS.PHYSIQUE,
    },
  }),
  prisma.property.create({
    data: {
      name: 'fluide',
      description: 'Qui coule facilement, se d√©place avec fluidit√©',
      category: CATEGORY_KEYS.PHYSIQUE,
    },
  }),
  prisma.property.create({
    data: {
      name: 'transparent',
      description: 'Laisse passer la lumi√®re, permet de voir au travers',
      category: CATEGORY_KEYS.VISUEL,
    },
  }),

  // Propri√©t√©s abstraites
  prisma.property.create({
    data: {
      name: 'vital',
      description: 'Essentiel √† la vie, indispensable √† l\'existence',
      category: CATEGORY_KEYS.ABSTRAIT,
    },
  }),
  prisma.property.create({
    data: {
      name: 'energie',
      description: 'Plein d\'√©nergie, puissant, dynamique',
      category: CATEGORY_KEYS.ABSTRAIT,
    },
  }),
  prisma.property.create({
    data: {
      name: 'repos',
      description: 'Calme, reposant, tranquille',
      category: CATEGORY_KEYS.ABSTRAIT,
    },
  }),
  prisma.property.create({
    data: {
      name: 'mystere',
      description: 'Myst√©rieux, cach√©, √©nigmatique',
      category: CATEGORY_KEYS.ABSTRAIT,
    },
  }),
  prisma.property.create({
    data: {
      name: 'harmonie',
      description: '√âquilibr√©, harmonieux, en accord',
      category: CATEGORY_KEYS.ABSTRAIT,
    },
  }),
  prisma.property.create({
    data: {
      name: 'equilibre',
      description: 'En √©quilibre, stable, √©quilibr√©',
      category: CATEGORY_KEYS.ABSTRAIT,
    },
  }),
  prisma.property.create({
    data: {
      name: 'vie',
      description: 'Porteur de vie, vivifiant, qui donne la vie',
      category: CATEGORY_KEYS.ABSTRAIT,
    },
  }),

  // Propri√©t√©s de mouvement
  prisma.property.create({
    data: {
      name: 'vitesse',
      description: 'Rapide, v√©loce, qui se d√©place rapidement',
      category: CATEGORY_KEYS.MOUVEMENT,
    },
  }),
  prisma.property.create({
    data: {
      name: 'dynamique',
      description: 'En mouvement, actif, plein de dynamisme',
      category: CATEGORY_KEYS.MOUVEMENT,
    },
  }),

  // Propri√©t√©s visuelles/lumineuses
  prisma.property.create({
    data: {
      name: 'lumiere',
      description: '√âmetteur ou porteur de lumi√®re, lumineux',
      category: CATEGORY_KEYS.VISUEL,
    },
  }),
  prisma.property.create({
    data: {
      name: 'obscurite',
      description: 'Sombre, sans lumi√®re, dans l\'obscurit√©',
      category: CATEGORY_KEYS.VISUEL,
    },
  }),
  prisma.property.create({
    data: {
      name: 'esthetique',
      description: 'Beau, agr√©able √† regarder, esth√©tiquement plaisant',
      category: CATEGORY_KEYS.VISUEL,
    },
  }),

  // Propri√©t√©s sensorielles
  prisma.property.create({
    data: {
      name: 'chaleur',
      description: 'Chaud, r√©chauffant, qui d√©gage de la chaleur',
      category: CATEGORY_KEYS.SENSORIEL,
    },
  }),

  // Propri√©t√©s √©motionnelles
  prisma.property.create({
    data: {
      name: 'calme',
      description: 'Paisible, tranquille, qui apporte le calme',
      category: CATEGORY_KEYS.EMOTION,
    },
  }),

  // Nouvelles propri√©t√©s pour enrichir le syst√®me
  prisma.property.create({
    data: {
      name: 'temporel',
      description: 'Li√© au temps, qui s\'√©tend dans la dur√©e',
      category: CATEGORY_KEYS.TEMPORAL,
    },
  }),
  prisma.property.create({
    data: {
      name: 'spatial',
      description: 'Li√© √† l\'espace, qui occupe un volume',
      category: CATEGORY_KEYS.SPATIAL,
    },
  }),
  prisma.property.create({
    data: {
      name: 'social',
      description: 'Relatif aux relations sociales, communautaire',
      category: CATEGORY_KEYS.SOCIAL,
    },
  }),
  prisma.property.create({
    data: {
      name: 'cognitif',
      description: 'Relatif aux processus mentaux et √† la cognition',
      category: CATEGORY_KEYS.COGNITIF,
    },
  }),

  // Propri√©t√©s linguistiques (si vous en avez besoin)
  prisma.property.create({
    data: {
      name: 'grammatical',
      description: 'Propri√©t√© grammaticale, r√®gle de grammaire',
      category: CATEGORY_KEYS.GRAMMATICAL,
    },
  }),
  prisma.property.create({
    data: {
      name: 'semantique',
      description: 'Relatif au sens, √† la signification',
      category: CATEGORY_KEYS.SEMANTIC,
    },
  }),
]);

  console.log('üè∑Ô∏è  Propri√©t√©s cr√©√©es:', properties.length);

  // Cr√©er un mapping pour faciliter la recherche
  const propMap = properties.reduce((acc, prop) => {
    acc[prop.name] = prop.id;
    return acc;
  }, {} as Record<string, string>);

  // Cr√©er les concepts avec leurs propri√©t√©s li√©es
  const concepts = await Promise.all([
    // Concept "go" (eau)
    prisma.concept.create({
      data: {
        id: 'go',
        mot: 'go',
        definition: 'eau, √©l√©ment liquide',
        type: 'element',
        exemples: JSON.stringify(['go tomu = cascade', 'go kala = eau pure']),
        usageFrequency: 0.85,
        createdBy: users[0].id,
        conceptProperties: {
          create: [
            { propertyId: propMap['liquide'] },
            { propertyId: propMap['fluide'] },
            { propertyId: propMap['vital'] },
            { propertyId: propMap['transparent'] },
          ]
        }
      },
    }),
    // Concept "tomu" (mouvement rapide)
    prisma.concept.create({
      data: {
        id: 'tomu',
        mot: 'tomu', 
        definition: 'mouvement rapide, vitesse',
        type: 'action',
        exemples: JSON.stringify(['tomu sol = √©clair', 'go tomu = torrent']),
        usageFrequency: 0.72,
        createdBy: users[0].id,
        conceptProperties: {
          create: [
            { propertyId: propMap['vitesse'] },
            { propertyId: propMap['dynamique'] },
            { propertyId: propMap['energie'] },
          ]
        }
      },
    }),
    // Concept "sol" (soleil)
    prisma.concept.create({
      data: {
        id: 'sol',
        mot: 'sol',
        definition: 'soleil, lumi√®re solaire, chaleur',
        type: 'element',
        exemples: JSON.stringify(['sol nox = cr√©puscule', 'sol kala = beaut√© dor√©e']),
        usageFrequency: 0.78,
        createdBy: users[1].id,
        conceptProperties: {
          create: [
            { propertyId: propMap['lumiere'] },
            { propertyId: propMap['chaleur'] },
            { propertyId: propMap['energie'] },
            { propertyId: propMap['vie'] },
          ]
        }
      },
    }),
    // Concept "nox" (nuit)
    prisma.concept.create({
      data: {
        id: 'nox',
        mot: 'nox',
        definition: 'obscurit√©, nuit, repos',
        type: 'element', 
        exemples: JSON.stringify(['nox kala = beaut√© nocturne', 'nox go = eau sombre']),
        usageFrequency: 0.65,
        createdBy: users[1].id,
        conceptProperties: {
          create: [
            { propertyId: propMap['obscurite'] },
            { propertyId: propMap['repos'] },
            { propertyId: propMap['mystere'] },
            { propertyId: propMap['calme'] },
          ]
        }
      },
    }),
    // Concept "kala" (beaut√©)
    prisma.concept.create({
      data: {
        id: 'kala',
        mot: 'kala',
        definition: 'beaut√©, harmonie esth√©tique',
        type: 'propriete',
        exemples: JSON.stringify(['kala sol = beaut√© dor√©e', 'go kala = beaut√© liquide']),
        usageFrequency: 0.60,
        createdBy: users[2].id,
        conceptProperties: {
          create: [
            { propertyId: propMap['esthetique'] },
            { propertyId: propMap['harmonie'] },
            { propertyId: propMap['equilibre'] },
          ]
        }
      },
    }),
  ]);

  console.log('üíé Concepts cr√©√©s:', concepts.length);

  // Mettre √† jour le compteur d'usage des propri√©t√©s
  for (const property of properties) {
    const usageCount = await prisma.conceptProperty.count({
      where: { propertyId: property.id }
    });
    
    await prisma.property.update({
      where: { id: property.id },
      data: { usageCount }
    });
  }

  console.log('üìä Compteurs d\'usage mis √† jour');

  // Cr√©er des combinaisons de test (inchang√©)
  const combinations = await Promise.all([
    prisma.combination.create({
      data: {
        pattern: JSON.stringify(['go', 'tomu']),
        sens: 'torrent, cascade, chute d\'eau rapide',
        description: 'Combinaison √©vidente : eau + mouvement rapide',
        statut: 'ADOPTE',
        confidenceScore: 0.95,
        source: 'MANUAL',
        createdBy: users[0].id,
        validatedAt: new Date(),
      },
    }),
    prisma.combination.create({
      data: {
        pattern: JSON.stringify(['sol', 'go']),
        sens: 'reflet du soleil sur l\'eau, miroitement',
        description: 'Image po√©tique du soleil se refl√©tant dans l\'eau',
        statut: 'EN_COURS',
        confidenceScore: 0.80,
        source: 'LLM_SUGGESTED',
        createdBy: users[1].id,
      },
    }),
    prisma.combination.create({
      data: {
        pattern: JSON.stringify(['nox', 'kala']),
        sens: 'beaut√© nocturne, splendeur de la nuit',
        description: 'La beaut√© particuli√®re de la nuit √©toil√©e',
        statut: 'PROPOSITION',
        confidenceScore: 0.75,
        source: 'MANUAL',
        createdBy: users[2].id,
      },
    }),
  ]);

  console.log('üîó Combinaisons cr√©√©es:', combinations.length);

  // Cr√©er des votes de test
  const votes = await Promise.all([
    // Votes pour "go tomu" (adopt√©)
    prisma.combinationVote.create({
      data: {
        combinationId: combinations[0].id,
        userId: users[1].id,
        vote: 'POUR',
        commentaire: 'Parfaitement logique et intuitif',
      },
    }),
    prisma.combinationVote.create({
      data: {
        combinationId: combinations[0].id,
        userId: users[2].id,
        vote: 'POUR',
        commentaire: 'J\'approuve totalement',
      },
    }),
    // Votes pour "sol go" (en cours)  
    prisma.combinationVote.create({
      data: {
        combinationId: combinations[1].id,
        userId: users[0].id,
        vote: 'POUR',
        commentaire: 'Belle image po√©tique',
      },
    }),
  ]);

  console.log('üó≥Ô∏è  Votes cr√©√©s:', votes.length);

  console.log('');
  console.log('‚úÖ Seed termin√© !');
  console.log('');
  console.log('üìä R√©sum√©:');
  console.log(`   üë• Utilisateurs: ${users.length}`);
  console.log(`   üè∑Ô∏è  Propri√©t√©s: ${properties.length}`);
  console.log(`   üíé Concepts: ${concepts.length}`);
  console.log(`   üîó Combinaisons: ${combinations.length}`);
  console.log(`   üó≥Ô∏è  Votes: ${votes.length}`);
  console.log('');
  console.log('üë• Comptes de test cr√©√©s :');
  console.log('  admin@conlang.local / password123 (Admin)');  
  console.log('  alice@conlang.local / password123 (Member)');
  console.log('  bob@conlang.local / password123 (Member)');
  console.log('  charlie@conlang.local / password123 (Moderator)');
}

main()
  .catch((e) => {
    console.error('‚ùå Erreur lors du seed:', e);
    process.exit(1);
  })
  .finally(async () => {
    await prisma.$disconnect();
  });